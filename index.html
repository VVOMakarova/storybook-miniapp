<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Storybook Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #0f172a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px;
      min-height: 100vh;
      background: radial-gradient(circle at 10% 20%, #c2f0ff 0, #9de1ff 25%, #77cffc 60%, #5ab8f5 100%);
      position: relative;
      overflow-x: hidden;
    }

    /* –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—É–∑—ã—Ä–∏ –Ω–∞ —Ñ–æ–Ω–µ (–Ω–µ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ) */
    .decor-bubbles {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
    }
    .decor-bubble {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(255,255,255,0));
      border: 1px solid rgba(255,255,255,0.9);
      opacity: 0.55;
      filter: blur(0.5px);
    }
    .decor-bubble--1 { width: 140px; height: 140px; top: 6%;  left: 6%; }
    .decor-bubble--2 { width: 110px; height: 110px; top: 18%; right: 10%; }
    .decor-bubble--3 { width: 90px;  height: 90px;  bottom: 18%; left: 15%; }
    .decor-bubble--4 { width: 160px; height: 160px; bottom: -30px; right: -10px; opacity: 0.4; }
    .decor-bubble--5 { width: 70px;  height: 70px;  top: 50%; left: 55%; opacity: 0.45; }

    .container { max-width: 480px; margin: 0 auto; }

    .bubble-card {
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.95), rgba(255,255,255,0.78));
      border-radius: 32px;
      padding: 18px 16px 20px;
      box-shadow:
        0 18px 40px rgba(15,23,42,0.35),
        0 0 0 1px rgba(255,255,255,0.7);
      backdrop-filter: blur(12px);
    }

    .hero {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
    }
    .hero-illustration {
      width: 84px;
      height: 84px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffe0f2 0, #ffb6dd 45%, #ff9fd6 80%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 8px 18px rgba(244,114,182,0.5),
        0 0 0 3px rgba(255,255,255,0.8);
      overflow: hidden;
    }
    .hero-emoji {
      font-size: 40px;
      line-height: 1;
      transform: translateY(2px);
    }
    .hero-text { flex: 1; min-width: 0; }
    h1 { font-size: 20px; margin: 0 0 4px; }
    p.description { font-size: 13px; margin: 0; color: #4b5563; }

    .lang-switch {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 10px;
    }
    .lang-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      background: rgba(255,255,255,0.9);
      padding: 4px 12px;
      font-size: 11px;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(15,23,42,0.15);
      transition: all 0.18s ease;
      color: #000000;
    }
    .lang-btn--active {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #000000;
      border-color: transparent;
      box-shadow:
        0 4px 10px rgba(79,70,229,0.55),
        0 0 0 1px rgba(255,255,255,0.8) inset;
    }

    form { margin-top: 10px; }

    .field {
      margin-bottom: 12px;
      padding: 8px 10px 10px;
      border-radius: 18px;
      background: radial-gradient(circle at 15% 10%, rgba(255,255,255,0.98), rgba(255,255,255,0.78));
      box-shadow:
        0 6px 12px rgba(15,23,42,0.12),
        0 0 0 1px rgba(255,255,255,0.85);
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #334155;
    }

    .field-hint {
      display: block;
      margin-top: 4px;
      font-size: 11px;
      color: #6b7280;
    }

    .field-subtitle {
      display: block;
      margin: 6px 0 6px;
      font-size: 11px;
      color: #475569;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 13px;
      outline: none;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 4px rgba(15,23,42,0.05) inset;
    }
    textarea { border-radius: 18px; resize: vertical; min-height: 60px; }
    input::placeholder, textarea::placeholder { color: #9ca3af; }
    input:focus, select:focus, textarea:focus {
      border-color: #6366f1;
      box-shadow:
        0 0 0 1px rgba(129,140,248,0.6),
        0 0 0 4px rgba(129,140,248,0.26);
      background: #ffffff;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .chip {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.85);
      background: rgba(255,255,255,0.92);
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      color: #0f172a;
      box-shadow: 0 3px 6px rgba(15,23,42,0.10);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
      text-align: left;
    }
    .chip:active { transform: translateY(1px); filter: brightness(0.99); }
    .chip--active {
      background: linear-gradient(135deg, rgba(99,102,241,0.95), rgba(139,92,246,0.95));
      border-color: transparent;
      color: #0b1020;
      box-shadow: 0 6px 14px rgba(79,70,229,0.35), 0 0 0 1px rgba(255,255,255,0.9) inset;
    }
    .chip small { display: block; font-size: 10px; color: rgba(15,23,42,0.72); }
    .chip--active small { color: rgba(15,23,42,0.82); }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media (max-width: 390px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }

    .hidden { display: none !important; }

    /* --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è --- */
    .mode-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 6px;
    }
    .mode-tile {
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.85);
      background: rgba(255,255,255,0.92);
      padding: 10px;
      cursor: pointer;
      color: #0f172a;
      box-shadow: 0 6px 12px rgba(15,23,42,0.10);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;

      display: flex;
      flex-direction: column;
      justify-content: space-between;
      text-align: left;

      aspect-ratio: 1 / 1; /* –¥–µ–ª–∞–µ—Ç –∏—Ö "–∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∞–º–∏" */
      min-height: 78px;    /* –∑–∞–ø–∞—Å –Ω–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    }
    .mode-tile:active { transform: translateY(1px); filter: brightness(0.99); }
    .mode-tile--active {
      background: linear-gradient(135deg, rgba(99,102,241,0.95), rgba(139,92,246,0.95));
      border-color: transparent;
      color: #0b1020;
      box-shadow: 0 10px 18px rgba(79,70,229,0.30), 0 0 0 1px rgba(255,255,255,0.9) inset;
    }
    .mode-tile span { font-size: 12px; font-weight: 600; line-height: 1.15; }
    .mode-tile small { font-size: 10px; color: rgba(15,23,42,0.72); line-height: 1.2; }
    .mode-tile--active small { color: rgba(15,23,42,0.82); }
    @media (max-width: 390px) {
      .mode-grid { grid-template-columns: 1fr; }
      .mode-tile { aspect-ratio: auto; min-height: 64px; }
    }

    /* --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –≤—ã–¥–µ–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ —Ü–≤–µ—Ç–æ–º --- */
    .attention-block {
      margin-top: 10px;
      padding: 12px 12px 12px;
      border-radius: 18px;
      background: radial-gradient(circle at 15% 10%, rgba(255,255,255,0.98), rgba(221,214,254,0.55));
      border: 1px solid rgba(139,92,246,0.35);
      box-shadow:
        0 10px 18px rgba(79,70,229,0.12),
        0 0 0 1px rgba(255,255,255,0.85) inset;
    }
    .attention-title {
      display: block;
      margin: 0 0 8px;
      font-size: 11px;
      font-weight: 700;
      color: #4338ca;
      letter-spacing: 0.2px;
    }

    button {
      width: 100%;
      padding: 11px 16px;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: radial-gradient(circle at 20% 0, #a5b4fc, #6366f1);
      color: #ffffff;
      box-shadow:
        0 10px 20px rgba(79,70,229,0.55),
        0 0 0 1px rgba(255,255,255,0.9) inset;
      margin-top: 4px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow:
        0 6px 14px rgba(79,70,229,0.55),
        0 0 0 1px rgba(255,255,255,0.9) inset;
      filter: brightness(0.98);
    }
    button:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow:
        0 4px 8px rgba(148,163,184,0.5),
        0 0 0 1px rgba(255,255,255,0.9) inset;
    }

    .note {
      font-size: 11px;
      color: #475569;
      margin-top: 8px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="decor-bubbles">
    <span class="decor-bubble decor-bubble--1"></span>
    <span class="decor-bubble decor-bubble--2"></span>
    <span class="decor-bubble decor-bubble--3"></span>
    <span class="decor-bubble decor-bubble--4"></span>
    <span class="decor-bubble decor-bubble--5"></span>
  </div>

  <main class="container">
    <div class="bubble-card">
      <div class="lang-switch">
        <button type="button" class="lang-btn lang-btn--active" data-lang="ru">RU</button>
        <button type="button" class="lang-btn" data-lang="en">EN</button>
      </div>

      <div class="hero">
        <div class="hero-illustration">
          <span class="hero-emoji">üìñ</span>
        </div>
        <div class="hero-text">
          <h1 id="title">–°–æ–∑–¥–∞—Ç—å —Å–∫–∞–∑–∫—É</h1>
          <p class="description" id="description">
            –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Äî –±–æ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å–∫–∞–∑–∫—É –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –µ—ë –≤ —á–∞—Ç –≤ –≤–∏–¥–µ PDF-–∫–Ω–∏–≥–∏.
          </p>
        </div>
      </div>

      <form id="storyForm">
        <!-- –ü.1 -->
        <div class="field">
          <label for="main_hero_name" id="label_main_hero_name">–ò–º—è –≥–ª–∞–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è *</label>
          <input id="main_hero_name" name="main_hero_name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ê—Ä–∏–Ω–∞" />
        </div>

        <!-- –ü.2: —Ä–µ–∂–∏–º –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è -->
        <div class="field">
          <label id="label_main_hero_appearance_mode">–í–Ω–µ—à–Ω–æ—Å—Ç—å –≥–ª–∞–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è *</label>

          <!-- –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥ -->
          <div class="mode-grid" id="mainHeroModeChips">
            <button type="button" class="mode-tile mode-tile--active" data-value="auto" id="chip_main_auto">
              <span id="chip_main_auto_title">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–Ω–µ—à–Ω–æ—Å—Ç—å</span>
              <small id="chip_main_auto_desc">–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</small>
            </button>

            <button type="button" class="mode-tile" data-value="select" id="chip_main_select">
              <span id="chip_main_select_title">–í—ã–±—Ä–∞—Ç—å –≤–Ω–µ—à–Ω–æ—Å—Ç—å</span>
              <small id="chip_main_select_desc">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: –∫–æ–∂–∞, –≥–ª–∞–∑–∞, –≤–æ–ª–æ—Å—ã‚Ä¶</small>
            </button>

            <button type="button" class="mode-tile" data-value="photo" id="chip_main_photo">
              <span id="chip_main_photo_title">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</span>
              <small id="chip_main_photo_desc">–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ –≤ —á–∞—Ç –ø–æ—Å–ª–µ —Ñ–æ—Ä–º—ã</small>
            </button>
          </div>

          <input type="hidden" id="main_hero_appearance_mode" name="main_hero_appearance_mode" value="auto" />

          <!-- –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ -->
          <div id="mainHeroAppearanceBlock" class="attention-block hidden">
            <span class="attention-title" id="subtitle_main_appearance">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ (–¥–ª—è —É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç–∏)</span>

            <div class="grid-2">
              <div>
                <label for="main_age_years" id="label_main_age_years">–í–æ–∑—Ä–∞—Å—Ç (—Ü–∏—Ñ—Ä–æ–π)</label>
                <input id="main_age_years" name="main_age_years" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 4" />
              </div>
              <div>
                <label for="main_gender" id="label_main_gender">–ü–æ–ª</label>
                <select id="main_gender" name="main_gender">
                  <option value="unspecified" selected id="opt_gender_unspecified">–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="girl" id="opt_gender_girl">–î–µ–≤–æ—á–∫–∞</option>
                  <option value="boy" id="opt_gender_boy">–ú–∞–ª—å—á–∏–∫</option>
                </select>
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label for="main_skin_tone" id="label_main_skin_tone">–¢–æ–Ω –∫–æ–∂–∏ *</label>
                <select id="main_skin_tone" name="main_skin_tone">
                  <option value="" selected disabled id="opt_pick">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                  <option value="very_light" id="opt_skin_very_light">–û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π</option>
                  <option value="light" id="opt_skin_light">–°–≤–µ—Ç–ª—ã–π</option>
                  <option value="medium" id="opt_skin_medium">–°—Ä–µ–¥–Ω–∏–π</option>
                  <option value="tan" id="opt_skin_tan">–°–º—É–≥–ª—ã–π</option>
                  <option value="dark" id="opt_skin_dark">–¢—ë–º–Ω—ã–π</option>
                </select>
              </div>
              <div>
                <label for="main_face_shape" id="label_main_face_shape">–§–æ—Ä–º–∞ –ª–∏—Ü–∞</label>
                <select id="main_face_shape" name="main_face_shape">
                  <option value="unspecified" selected id="opt_face_unspecified">–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="round" id="opt_face_round">–ö—Ä—É–≥–ª–æ–µ</option>
                  <option value="oval" id="opt_face_oval">–û–≤–∞–ª—å–Ω–æ–µ</option>
                  <option value="long" id="opt_face_long">–£–¥–ª–∏–Ω—ë–Ω–Ω–æ–µ</option>
                </select>
              </div>
            </div>

            <div>
              <label for="main_face_accent" id="label_main_face_accent">–ê–∫—Ü–µ–Ω—Ç –ª–∏—Ü–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input id="main_face_accent" name="main_face_accent" maxlength="120" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –≤–µ—Å–Ω—É—à–∫–∏" />
              <small class="field-hint" id="hint_main_face_accent">–ö–æ—Ä–æ—Ç–∫–∞—è –¥–µ—Ç–∞–ª—å, –∫–æ—Ç–æ—Ä—É—é –≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.</small>
            </div>

            <span class="field-subtitle" id="subtitle_main_eyes">–ì–ª–∞–∑–∞</span>
            <div class="grid-3">
              <div>
                <label for="main_eyes_color" id="label_main_eyes_color">–¶–≤–µ—Ç *</label>
                <select id="main_eyes_color" name="main_eyes_color">
                  <option value="" selected disabled>–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                  <option value="brown" id="opt_eyes_brown">–ö–∞—Ä–∏–µ</option>
                  <option value="blue" id="opt_eyes_blue">–ì–æ–ª—É–±—ã–µ</option>
                  <option value="gray" id="opt_eyes_gray">–°–µ—Ä—ã–µ</option>
                  <option value="green" id="opt_eyes_green">–ó–µ–ª—ë–Ω—ã–µ</option>
                  <option value="hazel" id="opt_eyes_hazel">–û—Ä–µ—Ö–æ–≤—ã–µ</option>
                  <option value="unspecified" id="opt_eyes_unspecified">–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                </select>
              </div>
              <div>
                <label for="main_eyes_shape" id="label_main_eyes_shape">–§–æ—Ä–º–∞</label>
                <select id="main_eyes_shape" name="main_eyes_shape">
                  <option value="unspecified" selected id="opt_eyes_shape_unspecified">–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="round" id="opt_eyes_shape_round">–ö—Ä—É–≥–ª—ã–µ</option>
                  <option value="almond" id="opt_eyes_shape_almond">–ú–∏–Ω–¥a–ª–µ–≤–∏–¥–Ω—ã–µ</option>
                </select>
              </div>
              <div>
                <label for="main_eyes_size" id="label_main_eyes_size">–†–∞–∑–º–µ—Ä</label>
                <select id="main_eyes_size" name="main_eyes_size">
                  <option value="unspecified" selected id="opt_eyes_size_unspecified">–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="small" id="opt_eyes_size_small">–ù–µ–±–æ–ª—å—à–∏–µ</option>
                  <option value="medium" id="opt_eyes_size_medium">–°—Ä–µ–¥–Ω–∏–µ</option>
                  <option value="large" id="opt_eyes_size_large">–ö—Ä—É–ø–Ω—ã–µ</option>
                </select>
              </div>
            </div>

            <span class="field-subtitle" id="subtitle_main_hair">–í–æ–ª–æ—Å—ã</span>
            <div class="grid-3">
              <div>
                <label for="main_hair_color" id="label_main_hair_color">–¶–≤–µ—Ç *</label>
                <select id="main_hair_color" name="main_hair_color">
                  <option value="" selected disabled>–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                  <option value="blond" id="opt_hair_blond">–ë–ª–æ–Ω–¥</option>
                  <option value="light_brown" id="opt_hair_light_brown">–†—É—Å—ã–µ</option>
                  <option value="chestnut" id="opt_hair_chestnut">–ö–∞—à—Ç–∞–Ω–æ–≤—ã–µ</option>
                  <option value="dark" id="opt_hair_dark">–¢—ë–º–Ω—ã–µ</option>
                  <option value="red" id="opt_hair_red">–†—ã–∂–∏–µ</option>
                  <option value="black" id="opt_hair_black">–ß—ë—Ä–Ω—ã–µ</option>
                  <option value="unspecified" id="opt_hair_unspecified">–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                </select>
              </div>
              <div>
                <label for="main_hair_length" id="label_main_hair_length">–î–ª–∏–Ω–∞ *</label>
                <select id="main_hair_length" name="main_hair_length">
                  <option value="" selected disabled>–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                  <option value="very_short" id="opt_hair_len_very_short">–û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ</option>
                  <option value="short" id="opt_hair_len_short">–ö–æ—Ä–æ—Ç–∫–∏–µ</option>
                  <option value="shoulder" id="opt_hair_len_shoulder">–î–æ –ø–ª–µ—á</option>
                  <option value="long" id="opt_hair_len_long">–î–ª–∏–Ω–Ω—ã–µ</option>
                  <option value="unspecified" id="opt_hair_len_unspecified">–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                </select>
              </div>
              <div>
                <label for="main_hair_type" id="label_main_hair_type">–¢–∏–ø *</label>
                <select id="main_hair_type" name="main_hair_type">
                  <option value="" selected disabled>–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
                  <option value="straight" id="opt_hair_type_straight">–ü—Ä—è–º—ã–µ</option>
                  <option value="wavy" id="opt_hair_type_wavy">–í–æ–ª–Ω–∏—Å—Ç—ã–µ</option>
                  <option value="curly" id="opt_hair_type_curly">–ö—É–¥—Ä—è–≤—ã–µ</option>
                  <option value="unspecified" id="opt_hair_type_unspecified">–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                </select>
              </div>
            </div>

            <div class="grid-3">
              <div>
                <label for="main_hair_density" id="label_main_hair_density">–ì—É—Å—Ç–æ—Ç–∞</label>
                <select id="main_hair_density" name="main_hair_density">
                  <option value="unspecified" selected>–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="thin">–†–µ–¥–∫–∏–µ</option>
                  <option value="medium">–°—Ä–µ–¥–Ω–∏–µ</option>
                  <option value="thick">–ì—É—Å—Ç—ã–µ</option>
                </select>
              </div>
              <div>
                <label for="main_bangs" id="label_main_bangs">–ß—ë–ª–∫–∞</label>
                <select id="main_bangs" name="main_bangs">
                  <option value="unspecified" selected>–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="yes">–ï—Å—Ç—å</option>
                  <option value="no">–ù–µ—Ç</option>
                </select>
              </div>
              <div>
                <label for="main_parting" id="label_main_parting">–ü—Ä–æ–±–æ—Ä</label>
                <select id="main_parting" name="main_parting">
                  <option value="unspecified" selected>–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="left">–°–ª–µ–≤–∞</option>
                  <option value="right">–°–ø—Ä–∞–≤–∞</option>
                  <option value="center">–ü–æ —Ü–µ–Ω—Ç—Ä—É</option>
                </select>
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label for="main_nose" id="label_main_nose">–ù–æ—Å</label>
                <select id="main_nose" name="main_nose">
                  <option value="unspecified" selected>–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="small">–ú–∞–ª–µ–Ω—å–∫–∏–π</option>
                  <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                  <option value="prominent">–í—ã—Ä–∞–∂–µ–Ω–Ω—ã–π</option>
                </select>
              </div>
              <div>
                <label for="main_lips" id="label_main_lips">–ì—É–±—ã</label>
                <select id="main_lips" name="main_lips">
                  <option value="unspecified" selected>–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="thin">–¢–æ–Ω–∫–∏–µ</option>
                  <option value="medium">–°—Ä–µ–¥–Ω–∏–µ</option>
                  <option value="full">–ü—É—Ö–ª—ã–µ</option>
                </select>
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label for="main_body_type" id="label_main_body_type">–¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ</label>
                <select id="main_body_type" name="main_body_type">
                  <option value="unspecified" selected>–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="slim">–•—É–¥–æ—â–∞–≤–æ–µ</option>
                  <option value="average">–°—Ä–µ–¥–Ω–µ–µ</option>
                  <option value="chubby">–ü—É—Ö–ª–µ–Ω—å–∫–æ–µ</option>
                </select>
              </div>
              <div>
                <label for="main_height_vs_peers" id="label_main_height_vs_peers">–†–æ—Å—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–≤–µ—Ä—Å—Ç–Ω–∏–∫–æ–≤</label>
                <select id="main_height_vs_peers" name="main_height_vs_peers">
                  <option value="unspecified" selected>–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                  <option value="shorter">–ù–∏–∂–µ</option>
                  <option value="average">–°—Ä–µ–¥–Ω–∏–π</option>
                  <option value="taller">–í—ã—à–µ</option>
                </select>
              </div>
            </div>

            <div>
              <label for="main_special_features" id="label_main_special_features">–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–±—ë–Ω–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input id="main_special_features" name="main_special_features" maxlength="160" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–æ—Å–∏—Ç –æ—á–∫–∏ –∫—Ä—É–≥–ª–æ–π —Ñ–æ—Ä–º—ã" />
            </div>
            <div>
              <label for="main_signature_look" id="label_main_signature_look">–§–∏—Ä–º–µ–Ω–Ω—ã–π –æ–±—Ä–∞–∑ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input id="main_signature_look" name="main_signature_look" maxlength="160" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–æ—Å–∏—Ç —Ä–æ–∑–æ–≤—ã–π —Å–≤–∏—Ç–µ—Ä" />
            </div>
          </div>
        </div>

        <!-- –ü.3 -->
        <div class="field">
          <label for="second_hero_name" id="label_second_hero_name">–ò–º—è –≤—Ç–æ—Ä–æ–≥–æ –≥–µ—Ä–æ—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input id="second_hero_name" name="second_hero_name" placeholder="–ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º" />
          <small class="field-hint" id="hint_second_hero_name">–ï—Å–ª–∏ –∏–º—è –Ω–µ –∑–∞–¥–∞–Ω–æ, –≤—Ç–æ—Ä–æ–π –≥–µ—Ä–æ–π –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è.</small>
        </div>

        <!-- –ü.4 -->
        <div class="field hidden" id="secondHeroBlock">
          <label id="label_second_hero_mode">–í–Ω–µ—à–Ω–æ—Å—Ç—å –≤—Ç–æ—Ä–æ–≥–æ –≥–µ—Ä–æ—è</label>

          <div class="chip-row" id="secondHeroModeChips">
            <button type="button" class="chip chip--active" data-value="preset" id="chip_second_preset">
              <span id="chip_second_preset_title">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</span>
              <small id="chip_second_preset_desc">6 –≥–æ—Ç–æ–≤—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</small>
            </button>
            <button type="button" class="chip" data-value="custom" id="chip_second_custom">
              <span id="chip_second_custom_title">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä</span>
              <small id="chip_second_custom_desc">–ö–æ—Ä–æ—Ç–∫–∞—è –∞–Ω–∫–µ—Ç–∞</small>
            </button>
            <button type="button" class="chip" data-value="photo" id="chip_second_photo">
              <span id="chip_second_photo_title">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</span>
              <small id="chip_second_photo_desc">–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ –≤ —á–∞—Ç –ø–æ—Å–ª–µ —Ñ–æ—Ä–º—ã</small>
            </button>
          </div>

          <input type="hidden" id="second_hero_mode" name="second_hero_mode" value="preset" />
          <input type="hidden" id="second_hero_preset_id" name="second_hero_preset_id" value="puzyrek" />

          <small class="field-hint" id="hint_second_hero_mode">
            –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ¬ª, –±–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –ø—Ä–∏—Å–ª–∞—Ç—å —Ñ–æ—Ç–æ –≤ —á–∞—Ç–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã.
          </small>

          <div id="secondHeroPresetBlock">
            <span class="field-subtitle" id="subtitle_second_presets">–ì–æ—Ç–æ–≤—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</span>
            <div class="chip-row" id="secondHeroPresetChips">
              <button type="button" class="chip" data-preset="foxik">
                <span id="preset_foxik_title">–õ–∏—Å—ë–Ω–æ–∫ –§–æ–∫—Å–∏–∫</span>
                <small id="preset_foxik_desc">–ë—ã—Å—Ç—Ä—ã–π, –ª—é–±–æ–ø—ã—Ç–Ω—ã–π, –ª—é–±–∏—Ç –∑–∞–≥–∞–¥–∫–∏</small>
              </button>
              <button type="button" class="chip" data-preset="tikhonya">
                <span id="preset_tikhonya_title">–°–æ–≤–∞ –¢–∏—Ö–æ–Ω—è</span>
                <small id="preset_tikhonya_desc">–°–ø–æ–∫–æ–π–Ω–∞—è, –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω–∞—è, –æ–±—ä—è—Å–Ω—è–µ—Ç –ø—Ä–æ—Å—Ç–æ</small>
              </button>
              <button type="button" class="chip" data-preset="bublik">
                <span id="preset_bublik_title">–©–µ–Ω–æ–∫ –ë—É–±–ª–∏–∫</span>
                <small id="preset_bublik_desc">–î–æ–±—Ä—ã–π, –≤–µ—Ä–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç</small>
              </button>
              <button type="button" class="chip" data-preset="pixel">
                <span id="preset_pixel_title">–†–æ–±–æ—Ç –ü–∏–∫—Å–µ–ª—å</span>
                <small id="preset_pixel_desc">–ò–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, —Å—Ç—Ä–æ–∏—Ç –∫–∞—Ä—Ç—ã</small>
              </button>
              <button type="button" class="chip" data-preset="iskrik">
                <span id="preset_iskrik_title">–î—Ä–∞–∫–æ–Ω—á–∏–∫ –ò—Å–∫—Ä–∏–∫</span>
                <small id="preset_iskrik_desc">–ë–µ–∑–æ–±–∏–¥–Ω—ã–π, ¬´—Å–æ–≥—Ä–µ–≤–∞–µ—Ç¬ª —Å–º–µ–ª–æ—Å—Ç—å</small>
              </button>
              <button type="button" class="chip chip--active" data-preset="puzyrek" id="preset_puzyrek_chip">
                <span id="preset_puzyrek_title">–ú–æ—Ä—Å–∫–æ–π –∫–æ–Ω—ë–∫ –ü—É–∑—ã—Ä—ë–∫</span>
                <small id="preset_puzyrek_desc">–ò–≥—Ä–∏–≤—ã–π, –∑–Ω–∞–µ—Ç –º–æ—Ä—Å–∫–∏–µ —Å–µ–∫—Ä–µ—Ç—ã</small>
              </button>
            </div>
          </div>

          <div id="secondHeroCustomBlock" class="hidden">
            <span class="field-subtitle" id="subtitle_second_custom">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä (–∫—Ä–∞—Ç–∫–æ)</span>

            <div class="grid-2">
              <div>
                <label for="second_custom_type" id="label_second_custom_type">–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
                <select id="second_custom_type" name="second_custom_type">
                  <option value="animal">–ñ–∏–≤–æ—Ç–Ω–æ–µ</option>
                  <option value="human">–ß–µ–ª–æ–≤–µ–∫</option>
                  <option value="toy">–ò–≥—Ä—É—à–∫–∞</option>
                  <option value="fantasy">–°–∫–∞–∑–æ—á–Ω–æ–µ —Å—É—â–µ—Å—Ç–≤–æ</option>
                  <option value="robot">–†–æ–±–æ—Ç</option>
                  <option value="animated_object">–ü—Ä–µ–¥–º–µ—Ç ‚Äú–æ–∂–∏–≤—à–∏–π‚Äù</option>
                  <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
              </div>
              <div>
                <label for="second_custom_role" id="label_second_custom_role">–ö–ª—é—á–µ–≤–∞—è —Ä–æ–ª—å</label>
                <select id="second_custom_role" name="second_custom_role">
                  <option value="helper">–ü–æ–º–æ—â–Ω–∏–∫</option>
                  <option value="friend">–î—Ä—É–≥</option>
                  <option value="mentor">–ù–∞—Å—Ç–∞–≤–Ω–∏–∫</option>
                  <option value="companion">–°–ø—É—Ç–Ω–∏–∫</option>
                  <option value="wise_advisor">–£–º–Ω—ã–π —Å–æ–≤–µ—Ç—á–∏–∫</option>
                  <option value="comic">–ö–æ–º–∏—á–µ—Å–∫–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂</option>
                </select>
              </div>
            </div>

            <div id="secondTypeOtherWrap" class="hidden">
              <label for="second_custom_type_other_text" id="label_second_custom_type_other_text">–£—Ç–æ—á–Ω–∏—Ç–µ —Ç–∏–ø</label>
              <input id="second_custom_type_other_text" name="second_custom_type_other_text" maxlength="60" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –æ–±–ª–∞—á–∫–æ" />
            </div>

            <label id="label_second_traits">3 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (—Å—Ç—Ä–æ–≥–æ —Ç—Ä–∏)</label>
            <div class="grid-3">
              <input id="second_trait_1" maxlength="20" placeholder="—Å–º–µ–ª—ã–π" />
              <input id="second_trait_2" maxlength="20" placeholder="–¥–æ–±—Ä—ã–π" />
              <input id="second_trait_3" maxlength="20" placeholder="–ª—é–±–æ–ø—ã—Ç–Ω—ã–π" />
            </div>

            <label id="label_second_markers">–í–∏–∑—É–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã (2‚Äì3 –ø—Ä–∏–∑–Ω–∞–∫–∞)</label>
            <div class="grid-3">
              <input id="second_marker_1" maxlength="40" placeholder="–≥–æ–ª—É–±–∞—è —à–∞–ø–æ—á–∫–∞" />
              <input id="second_marker_2" maxlength="40" placeholder="–∫—Ä—É–≥–ª—ã–µ –æ—á–∫–∏" />
              <input id="second_marker_3" maxlength="40" placeholder="—Ä—é–∫–∑–∞—á–æ–∫ –±–µ–∑ –∑–Ω–∞–∫–æ–≤ (–æ–ø—Ü.)" />
            </div>

            <div>
              <label for="second_unique_prop" id="label_second_unique_prop">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ä–µ–∫–≤–∏–∑–∏—Ç (—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω –ø—Ä–µ–¥–º–µ—Ç, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input id="second_unique_prop" name="second_unique_prop" maxlength="40" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–º–ø–∞—Å" />
            </div>
          </div>
        </div>

        <!-- –ü.5: –º–µ—Å—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="field">
          <label id="label_setting_mode">–ú–µ—Å—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è *</label>

          <div class="chip-row" id="settingModeChips">
            <button type="button" class="chip chip--active" data-value="preset" id="chip_setting_preset">
              <span id="chip_setting_preset_title">–í—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ</span>
              <small id="chip_setting_preset_desc">6 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</small>
            </button>
            <button type="button" class="chip" data-value="custom" id="chip_setting_custom">
              <span id="chip_setting_custom_title">–ü–µ—Ä—Å–æ–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ</span>
              <small id="chip_setting_custom_desc">–¢–∏–ø, –≤—Ä–µ–º—è, —Å–µ–∑–æ–Ω, –¥–µ—Ç–∞–ª–∏</small>
            </button>
          </div>

          <input type="hidden" id="setting_mode" name="setting_mode" value="preset" />
          <input type="hidden" id="setting_preset_id" name="setting_preset_id" value="fun_yard" />

          <div id="settingPresetBlock">
            <span class="field-subtitle" id="subtitle_setting_presets">–ì–æ—Ç–æ–≤—ã–µ –º–µ—Å—Ç–∞</span>
            <div class="chip-row" id="settingPresetChips">
              <button type="button" class="chip chip--active" data-preset="fun_yard" id="place_fun_yard">–î–≤–æ—Ä –≤–µ—Å—ë–ª—ã—Ö –∏–≥—Ä</button>
              <button type="button" class="chip" data-preset="warm_home" id="place_warm_home">–¢—ë–ø–ª—ã–π –¥–æ–º</button>
              <button type="button" class="chip" data-preset="city_road" id="place_city_road">–î–æ—Ä–æ–≥–∞ –≤ –≥–æ—Ä–æ–¥–µ</button>
              <button type="button" class="chip" data-preset="park_nature" id="place_park_nature">–ü–∞—Ä–∫ –∏ –ø—Ä–∏—Ä–æ–¥–∞</button>
              <button type="button" class="chip" data-preset="wonder_lab" id="place_wonder_lab">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è —á—É–¥–µ—Å</button>
              <button type="button" class="chip" data-preset="book_house" id="place_book_house">–î–æ–º –∫–Ω–∏–≥</button>
            </div>
          </div>

          <div id="settingCustomBlock" class="hidden">
            <span class="field-subtitle" id="subtitle_setting_custom">–ü–µ—Ä—Å–æ–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ</span>

            <div class="grid-2">
              <div>
                <label for="setting_custom_type" id="label_setting_custom_type">–¢–∏–ø –º–µ—Å—Ç–∞</label>
                <select id="setting_custom_type" name="setting_custom_type">
                  <option value="home">–î–æ–º</option>
                  <option value="playground">–ü–ª–æ—â–∞–¥–∫–∞</option>
                  <option value="school_garden">–°–∞–¥ –∏–ª–∏ —à–∫–æ–ª–∞</option>
                  <option value="park_forest">–ü–∞—Ä–∫ –∏–ª–∏ –ª–µ—Å</option>
                  <option value="city">–ì–æ—Ä–æ–¥</option>
                  <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
              </div>
              <div id="settingTypeOtherWrap" class="hidden">
                <label for="setting_custom_type_other_text" id="label_setting_custom_type_other_text">–£—Ç–æ—á–Ω–∏—Ç–µ —Ç–∏–ø</label>
                <input id="setting_custom_type_other_text" name="setting_custom_type_other_text" maxlength="60" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –æ–∫–µ–∞–Ω–∞—Ä–∏—É–º" />
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label for="setting_custom_time" id="label_setting_custom_time">–í—Ä–µ–º—è</label>
                <select id="setting_custom_time" name="setting_custom_time">
                  <option value="morning">–£—Ç—Ä–æ</option>
                  <option value="day" selected>–î–µ–Ω—å</option>
                  <option value="evening">–í–µ—á–µ—Ä</option>
                </select>
              </div>
              <div>
                <label for="setting_custom_season" id="label_setting_custom_season">–°–µ–∑–æ–Ω</label>
                <select id="setting_custom_season" name="setting_custom_season">
                  <option value="spring">–í–µ—Å–Ω–∞</option>
                  <option value="summer" selected>–õ–µ—Ç–æ</option>
                  <option value="autumn">–û—Å–µ–Ω—å</option>
                  <option value="winter">–ó–∏–º–∞</option>
                </select>
              </div>
            </div>

            <label id="label_setting_details">–¢—Ä–∏ –¥–µ—Ç–∞–ª–∏ –º–µ—Å—Ç–∞</label>
            <div class="grid-3">
              <input id="setting_detail_1" maxlength="40" placeholder="—Å–∏–Ω—è—è –¥–≤–µ—Ä—å" />
              <input id="setting_detail_2" maxlength="40" placeholder="–∫–æ–≤—ë—Ä —Å–æ –∑–≤—ë–∑–¥–∞–º–∏" />
              <input id="setting_detail_3" maxlength="40" placeholder="–±–æ–ª—å—à–æ–π —Ñ–∏–∫—É—Å" />
            </div>

            <label id="label_setting_realism">–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å</label>
            <div class="chip-row" id="settingRealismChips">
              <button type="button" class="chip chip--active" data-value="life" id="chip_realism_life">–ö–∞–∫ –≤ –∂–∏–∑–Ω–∏</button>
              <button type="button" class="chip" data-value="slightly_fairy" id="chip_realism_fairy">–ß—É—Ç—å —Å–∫–∞–∑–æ—á–Ω–æ, –Ω–æ —É–∑–Ω–∞–≤–∞–µ–º–æ</button>
            </div>
            <input type="hidden" id="setting_custom_realism" name="setting_custom_realism" value="life" />
          </div>
        </div>

        <!-- –ü.6 -->
        <div class="field">
          <label for="age_group" id="label_age_group">–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞ *</label>
          <select id="age_group" name="age_group" required>
            <option value="0_3">0‚Äì3</option>
            <option value="4_6" selected>4‚Äì6</option>
            <option value="7_12">7‚Äì12</option>
            <option value="12_16">12‚Äì16</option>
            <option value="16_plus">16+</option>
          </select>
        </div>

        <!-- –ü.7 -->
        <div class="field">
          <label for="narrative_style" id="label_narrative_style">–°—Ç–∏–ª—å –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è *</label>
          <select id="narrative_style" name="narrative_style" required>
            <option value="calm">–°–ø–æ–∫–æ–π–Ω—ã–π –º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—ã–π</option>
            <option value="adventure">–ü—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∏–π</option>
            <option value="mystery">–ó–∞–≥–∞–¥–æ—á–Ω—ã–π</option>
            <option value="humor">–° —é–º–æ—Ä–æ–º</option>
            <option value="lyric">–õ–∏—Ä–∏—á–µ—Å–∫–∏–π</option>
          </select>
        </div>

        <!-- –ü.8 -->
        <div class="field">
          <label for="moral_theme" id="label_moral_theme">–ü–æ—É—á–∏—Ç–µ–ª—å–Ω—ã–π —Å—é–∂–µ—Ç *</label>
          <select id="moral_theme" name="moral_theme" required>
            <option value="kindness_help">–î–æ–±—Ä–æ—Ç–∞ –∏ –ø–æ–º–æ—â—å –¥—Ä—É–≥–∏–º</option>
            <option value="power_of_friendship">–°–∏–ª–∞ –¥—Ä—É–∂–±—ã</option>
            <option value="honesty_trust">–ß–µ—Å—Ç–Ω–æ—Å—Ç—å –∏ –¥–æ–≤–µ—Ä–∏–µ</option>
            <option value="accepting_differences">–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–∞–∑–ª–∏—á–∏–π</option>
            <option value="admitting_mistakes">–£–º–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–≤–∞—Ç—å –æ—à–∏–±–∫–∏</option>
            <option value="patience_perseverance">–¢–µ—Ä–ø–µ–Ω–∏–µ –∏ –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å</option>
            <option value="care_for_nature">–ó–∞–±–æ—Ç–∞ –æ –ø—Ä–∏—Ä–æ–¥–µ</option>
            <option value="safety_caution">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å</option>
            <option value="respect_parents_adults">–£–≤–∞–∂–µ–Ω–∏–µ –∫ —Ä–æ–¥–∏—Ç–µ–ª—è–º –∏ –≤–∑—Ä–æ—Å–ª—ã–º</option>
            <option value="sharing">–£–º–µ–Ω–∏–µ –¥–µ–ª–∏—Ç—å—Å—è</option>
            <option value="independence_responsibility">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å</option>
            <option value="emotions_expression">–≠–º–æ—Ü–∏–∏ –∏ —É–º–µ–Ω–∏–µ –≥–æ–≤–æ—Ä–∏—Ç—å –æ –Ω–∏—Ö</option>
            <option value="anti_bullying">–ü—Ä–æ—Ç–∏–≤–æ—Å—Ç–æ—è–Ω–∏–µ –±—É–ª–ª–∏–Ω–≥—É</option>
            <option value="value_of_work">–¶–µ–Ω–Ω–æ—Å—Ç—å —Ç—Ä—É–¥–∞</option>
            <option value="tidiness_order">–ê–∫–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç—å –∏ –ø–æ—Ä—è–¥–æ–∫</option>
            <option value="gadgets_moderation">–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –≥–∞–¥–∂–µ—Ç–∞—Ö</option>
            <option value="gratitude">–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</option>
            <option value="imagination_creativity">–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ</option>
          </select>
        </div>

        <!-- –ü.9 -->
        <div class="field">
          <label for="illustration_style_id" id="label_illustration_style_id">–°—Ç–∏–ª—å –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–π *</label>
          <select id="illustration_style_id" name="illustration_style_id" required>
            <option value="storybook_semi_realism">–ü–æ–ª—É-—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –∫–Ω–∏–∂–Ω–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è</option>
            <option value="cartoon_3d">3D –º—É–ª—å—Ç</option>
            <option value="watercolor_ink">–ê–∫–≤–∞—Ä–µ–ª—å + —Ç—É—à—å</option>
            <option value="gouache_flat">–ì—É–∞—à—å / –ø–ª–æ—Å–∫–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è —Å –æ–±—ä—ë–º–æ–º</option>
            <option value="clean_vector">–í–µ–∫—Ç–æ—Ä–Ω–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è</option>
            <option value="anime">–ê–Ω–∏–º–µ</option>
          </select>
        </div>

        <!-- –ü.10 -->
        <div class="field">
          <label for="language" id="label_language">–Ø–∑—ã–∫ —Å–∫–∞–∑–∫–∏ *</label>
          <select id="language" name="language" required>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="en">English</option>
          </select>
        </div>

        <button type="submit" id="submitBtn">–°–æ–∑–¥–∞—Ç—å —Å–∫–∞–∑–∫—É</button>
        <p class="note" id="note">
          –ü–æ—Å–ª–µ —Ñ–æ—Ä–º—ã –±–æ—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç —Ñ–æ—Ç–æ –≤ —á–∞—Ç–µ. –ú–µ–¥–∏–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ —á–∞—Ç, –∞ MiniApp –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON.
        </p>
      </form>
    </div>
  </main>

  <script>
    const tg = window.Telegram?.WebApp || null;
    const isTelegramWebApp = Boolean(tg && (tg.initData || tg.initDataUnsafe));
    const WEBHOOK_URL = 'https://oglob.app.n8n.cloud/webhook-test/telegram-puzirek';

    if (isTelegramWebApp) {
      tg.ready();
      tg.expand();
    }

    const form = document.getElementById('storyForm');
    const submitBtn = document.getElementById('submitBtn');

    const sessionId = (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));

    const translations = {
      ru: {
        title: '–°–æ–∑–¥–∞—Ç—å —Å–∫–∞–∑–∫—É',
        description: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Äî –±–æ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å–∫–∞–∑–∫—É –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –µ—ë –≤ —á–∞—Ç –≤ –≤–∏–¥–µ PDF-–∫–Ω–∏–≥–∏.',
        main_hero_name_label: '–ò–º—è –≥–ª–∞–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è *',
        main_hero_name_placeholder: '–ù–∞–ø—Ä–∏–º–µ—Ä, –ê—Ä–∏–Ω–∞',

        main_hero_appearance_mode_label: '–í–Ω–µ—à–Ω–æ—Å—Ç—å –≥–ª–∞–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è *',
        main_mode_auto_title: '–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–Ω–µ—à–Ω–æ—Å—Ç—å',
        main_mode_auto_desc: '–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤',
        main_mode_select_title: '–í—ã–±—Ä–∞—Ç—å –≤–Ω–µ—à–Ω–æ—Å—Ç—å',
        main_mode_select_desc: '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: –∫–æ–∂–∞, –≥–ª–∞–∑–∞, –≤–æ–ª–æ—Å—ã‚Ä¶',
        main_mode_photo_title: '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ',
        main_mode_photo_desc: '–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ –≤ —á–∞—Ç –ø–æ—Å–ª–µ —Ñ–æ—Ä–º—ã',
        main_appearance_subtitle: '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ (–¥–ª—è —É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç–∏)',

        second_hero_name_label: '–ò–º—è –≤—Ç–æ—Ä–æ–≥–æ –≥–µ—Ä–æ—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)',
        second_hero_name_placeholder: '–ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º',
        second_hero_name_hint: '–ï—Å–ª–∏ –∏–º—è –Ω–µ –∑–∞–¥–∞–Ω–æ, –≤—Ç–æ—Ä–æ–π –≥–µ—Ä–æ–π –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è.',

        second_hero_mode_label: '–í–Ω–µ—à–Ω–æ—Å—Ç—å –≤—Ç–æ—Ä–æ–≥–æ –≥–µ—Ä–æ—è',
        second_mode_hint: '–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ¬ª, –±–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –ø—Ä–∏—Å–ª–∞—Ç—å —Ñ–æ—Ç–æ –≤ —á–∞—Ç–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã.',
        second_mode_preset_title: '–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞',
        second_mode_preset_desc: '6 –≥–æ—Ç–æ–≤—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤',
        second_mode_custom_title: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä',
        second_mode_custom_desc: '–ö–æ—Ä–æ—Ç–∫–∞—è –∞–Ω–∫–µ—Ç–∞',
        second_mode_photo_title: '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ',
        second_mode_photo_desc: '–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ –≤ —á–∞—Ç –ø–æ—Å–ª–µ —Ñ–æ—Ä–º—ã',
        second_presets_subtitle: '–ì–æ—Ç–æ–≤—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏',
        second_custom_subtitle: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä (–∫—Ä–∞—Ç–∫–æ)',

        setting_mode_label: '–ú–µ—Å—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è *',
        setting_mode_preset_title: '–í—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ',
        setting_mode_preset_desc: '6 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤',
        setting_mode_custom_title: '–ü–µ—Ä—Å–æ–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ',
        setting_mode_custom_desc: '–¢–∏–ø, –≤—Ä–µ–º—è, —Å–µ–∑–æ–Ω, –¥–µ—Ç–∞–ª–∏',
        setting_presets_subtitle: '–ì–æ—Ç–æ–≤—ã–µ –º–µ—Å—Ç–∞',
        setting_custom_subtitle: '–ü–µ—Ä—Å–æ–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ',

        age_group_label: '–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞ *',
        narrative_style_label: '–°—Ç–∏–ª—å –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è *',
        moral_theme_label: '–ü–æ—É—á–∏—Ç–µ–ª—å–Ω—ã–π —Å—é–∂–µ—Ç *',
        illustration_style_label: '–°—Ç–∏–ª—å –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–π *',
        language_label: '–Ø–∑—ã–∫ —Å–∫–∞–∑–∫–∏ *',

        submit: '–°–æ–∑–¥–∞—Ç—å —Å–∫–∞–∑–∫—É',
        note_base: '–ü–æ—Å–ª–µ —Ñ–æ—Ä–º—ã –±–æ—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç —Ñ–æ—Ç–æ –≤ —á–∞—Ç–µ. –ú–µ–¥–∏–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ —á–∞—Ç, –∞ MiniApp –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON.'
      },
      en: {
        title: 'Create a story',
        description: 'Fill in the fields ‚Äî the bot will generate a personalised story and send it to the chat as a PDF book.',
        main_hero_name_label: 'Main character‚Äôs name *',
        main_hero_name_placeholder: 'For example, Arina',

        main_hero_appearance_mode_label: 'Main character appearance *',
        main_mode_auto_title: 'Suggest an appearance',
        main_mode_auto_desc: 'Auto, no parameters',
        main_mode_select_title: 'Choose appearance',
        main_mode_select_desc: 'Skin, eyes, hair‚Ä¶',
        main_mode_photo_title: 'Upload photo',
        main_mode_photo_desc: 'Send it in chat after the form',
        main_appearance_subtitle: 'Appearance parameters (for recognisability)',

        second_hero_name_label: 'Second character‚Äôs name (optional)',
        second_hero_name_placeholder: 'You may leave this empty',
        second_hero_name_hint: 'If empty, the second character will not be added.',

        second_hero_mode_label: 'Second character appearance',
        second_mode_hint: 'If you choose ‚ÄúUpload photo‚Äù, the bot will ask for the photo in the chat after you submit the form.',
        second_mode_preset_title: 'Pick a character',
        second_mode_preset_desc: '6 ready presets',
        second_mode_custom_title: 'Custom',
        second_mode_custom_desc: 'Short questionnaire',
        second_mode_photo_title: 'Upload photo',
        second_mode_photo_desc: 'Send it in chat after the form',
        second_presets_subtitle: 'Ready characters',
        second_custom_subtitle: 'Custom (short)',

        setting_mode_label: 'Setting *',
        setting_mode_preset_title: 'Pick a place',
        setting_mode_preset_desc: '6 presets',
        setting_mode_custom_title: 'Personalised place',
        setting_mode_custom_desc: 'Type, time, season, details',
        setting_presets_subtitle: 'Preset places',
        setting_custom_subtitle: 'Personalised place',

        age_group_label: 'Age group *',
        narrative_style_label: 'Narrative style *',
        moral_theme_label: 'Educational plot *',
        illustration_style_label: 'Illustration style *',
        language_label: 'Story language *',

        submit: 'Create story',
        note_base: 'After submitting, the bot may ask for photos in the chat. Media is sent in chat; the MiniApp sends a structured JSON payload.'
      }
    };

    const urlParams = new URLSearchParams(window.location.search);
    const langFromUrl = urlParams.get('lang');
    const tgLang = (tg?.initDataUnsafe?.user?.language_code || '').toLowerCase();
    const defaultLang = langFromUrl || (tgLang.startsWith('ru') ? 'ru' : 'en');
    let currentLang = defaultLang;

    function setRequiredForMainAppearance(isOn) {
      const requiredIds = ['main_skin_tone','main_eyes_color','main_hair_color','main_hair_length','main_hair_type'];
      requiredIds.forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.required = Boolean(isOn);
      });
    }

    function applyTranslations(lang) {
      const t = translations[lang];
      currentLang = lang;
      document.documentElement.lang = lang;

      document.getElementById('title').textContent = t.title;
      document.getElementById('description').textContent = t.description;

      document.getElementById('label_main_hero_name').textContent = t.main_hero_name_label;
      document.getElementById('main_hero_name').placeholder = t.main_hero_name_placeholder;

      document.getElementById('label_main_hero_appearance_mode').textContent = t.main_hero_appearance_mode_label;
      document.getElementById('chip_main_auto_title').textContent = t.main_mode_auto_title;
      document.getElementById('chip_main_auto_desc').textContent = t.main_mode_auto_desc;
      document.getElementById('chip_main_select_title').textContent = t.main_mode_select_title;
      document.getElementById('chip_main_select_desc').textContent = t.main_mode_select_desc;
      document.getElementById('chip_main_photo_title').textContent = t.main_mode_photo_title;
      document.getElementById('chip_main_photo_desc').textContent = t.main_mode_photo_desc;
      document.getElementById('subtitle_main_appearance').textContent = t.main_appearance_subtitle;

      document.getElementById('label_second_hero_name').textContent = t.second_hero_name_label;
      document.getElementById('second_hero_name').placeholder = t.second_hero_name_placeholder;
      document.getElementById('hint_second_hero_name').textContent = t.second_hero_name_hint;

      document.getElementById('label_second_hero_mode').textContent = t.second_hero_mode_label;
      document.getElementById('hint_second_hero_mode').textContent = t.second_mode_hint;
      document.getElementById('chip_second_preset_title').textContent = t.second_mode_preset_title;
      document.getElementById('chip_second_preset_desc').textContent = t.second_mode_preset_desc;
      document.getElementById('chip_second_custom_title').textContent = t.second_mode_custom_title;
      document.getElementById('chip_second_custom_desc').textContent = t.second_mode_custom_desc;
      document.getElementById('chip_second_photo_title').textContent = t.second_mode_photo_title;
      document.getElementById('chip_second_photo_desc').textContent = t.second_mode_photo_desc;
      document.getElementById('subtitle_second_presets').textContent = t.second_presets_subtitle;
      document.getElementById('subtitle_second_custom').textContent = t.second_custom_subtitle;

      document.getElementById('label_setting_mode').textContent = t.setting_mode_label;
      document.getElementById('chip_setting_preset_title').textContent = t.setting_mode_preset_title;
      document.getElementById('chip_setting_preset_desc').textContent = t.setting_mode_preset_desc;
      document.getElementById('chip_setting_custom_title').textContent = t.setting_mode_custom_title;
      document.getElementById('chip_setting_custom_desc').textContent = t.setting_mode_custom_desc;
      document.getElementById('subtitle_setting_presets').textContent = t.setting_presets_subtitle;
      document.getElementById('subtitle_setting_custom').textContent = t.setting_custom_subtitle;

      document.getElementById('label_age_group').textContent = t.age_group_label;
      document.getElementById('label_narrative_style').textContent = t.narrative_style_label;
      document.getElementById('label_moral_theme').textContent = t.moral_theme_label;
      document.getElementById('label_illustration_style_id').textContent = t.illustration_style_label;
      document.getElementById('label_language').textContent = t.language_label;

      submitBtn.textContent = t.submit;
      document.getElementById('note').textContent = t.note_base;

      form.language.value = lang;
    }

    // utility: chips
    function setActiveChip(groupEl, predicateFn) {
      const chips = groupEl.querySelectorAll('.chip');
      chips.forEach((chip) => chip.classList.toggle('chip--active', Boolean(predicateFn(chip))));
    }

    // utility: mode tiles (–≥–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π)
    function setActiveModeTile(groupEl, predicateFn) {
      const tiles = groupEl.querySelectorAll('.mode-tile');
      tiles.forEach((tile) => tile.classList.toggle('mode-tile--active', Boolean(predicateFn(tile))));
    }

    applyTranslations(defaultLang);

    const langButtons = document.querySelectorAll('.lang-btn');
    langButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const lang = btn.dataset.lang;
        if (lang === currentLang) return;
        langButtons.forEach((b) => b.classList.toggle('lang-btn--active', b === btn));
        applyTranslations(lang);
        updateNote();
      });
    });

    // --- main hero mode ---
    const mainHeroModeChips = document.getElementById('mainHeroModeChips');
    const mainHeroModeInput = document.getElementById('main_hero_appearance_mode');
    const mainHeroAppearanceBlock = document.getElementById('mainHeroAppearanceBlock');

    function applyMainHeroMode(mode) {
      mainHeroModeInput.value = mode;
      setActiveModeTile(mainHeroModeChips, (tile) => tile.dataset.value === mode);

      const show = (mode === 'select');
      mainHeroAppearanceBlock.classList.toggle('hidden', !show);
      setRequiredForMainAppearance(show);

      updateNote();
    }

    mainHeroModeChips.addEventListener('click', (e) => {
      const btn = e.target.closest('.mode-tile');
      if (!btn) return;
      applyMainHeroMode(btn.dataset.value);
    });

    // default main mode
    applyMainHeroMode(mainHeroModeInput.value);

    // --- second hero block visibility by name ---
    const secondHeroNameInput = document.getElementById('second_hero_name');
    const secondHeroBlock = document.getElementById('secondHeroBlock');
    const secondHeroModeChips = document.getElementById('secondHeroModeChips');
    const secondHeroModeInput = document.getElementById('second_hero_mode');
    const secondHeroPresetIdInput = document.getElementById('second_hero_preset_id');
    const secondHeroPresetBlock = document.getElementById('secondHeroPresetBlock');
    const secondHeroPresetChips = document.getElementById('secondHeroPresetChips');
    const secondHeroCustomBlock = document.getElementById('secondHeroCustomBlock');

    function applySecondHeroMode(mode) {
      secondHeroModeInput.value = mode;
      setActiveChip(secondHeroModeChips, (chip) => chip.dataset.value === mode);

      secondHeroPresetBlock.classList.toggle('hidden', mode !== 'preset');
      secondHeroCustomBlock.classList.toggle('hidden', mode !== 'custom');

      updateNote();
    }

    function applySecondHeroVisibility() {
      const hasName = secondHeroNameInput.value.trim().length > 0;
      secondHeroBlock.classList.toggle('hidden', !hasName);

      if (!hasName) {
        secondHeroModeInput.value = 'none';
      } else {
        if (secondHeroModeInput.value === 'none') secondHeroModeInput.value = 'preset';
        applySecondHeroMode(secondHeroModeInput.value);
      }
      updateNote();
    }

    secondHeroNameInput.addEventListener('input', applySecondHeroVisibility);

    secondHeroModeChips.addEventListener('click', (e) => {
      const btn = e.target.closest('.chip');
      if (!btn) return;
      applySecondHeroMode(btn.dataset.value);
    });

    secondHeroPresetChips.addEventListener('click', (e) => {
      const btn = e.target.closest('.chip');
      if (!btn) return;
      const preset = btn.dataset.preset;
      if (!preset) return;
      secondHeroPresetIdInput.value = preset;
      setActiveChip(secondHeroPresetChips, (chip) => chip.dataset.preset === preset);
    });

    const secondCustomType = document.getElementById('second_custom_type');
    const secondTypeOtherWrap = document.getElementById('secondTypeOtherWrap');
    secondCustomType.addEventListener('change', () => {
      secondTypeOtherWrap.classList.toggle('hidden', secondCustomType.value !== 'other');
    });

    applySecondHeroVisibility();
    setActiveChip(secondHeroPresetChips, (chip) => chip.dataset.preset === secondHeroPresetIdInput.value);

    // --- setting mode ---
    const settingModeChips = document.getElementById('settingModeChips');
    const settingModeInput = document.getElementById('setting_mode');
    const settingPresetIdInput = document.getElementById('setting_preset_id');
    const settingPresetBlock = document.getElementById('settingPresetBlock');
    const settingCustomBlock = document.getElementById('settingCustomBlock');
    const settingPresetChips = document.getElementById('settingPresetChips');

    function applySettingMode(mode) {
      settingModeInput.value = mode;
      setActiveChip(settingModeChips, (chip) => chip.dataset.value === mode);
      settingPresetBlock.classList.toggle('hidden', mode !== 'preset');
      settingCustomBlock.classList.toggle('hidden', mode !== 'custom');
    }

    settingModeChips.addEventListener('click', (e) => {
      const btn = e.target.closest('.chip');
      if (!btn) return;
      applySettingMode(btn.dataset.value);
    });

    settingPresetChips.addEventListener('click', (e) => {
      const btn = e.target.closest('.chip');
      if (!btn) return;
      const preset = btn.dataset.preset;
      if (!preset) return;
      settingPresetIdInput.value = preset;
      setActiveChip(settingPresetChips, (chip) => chip.dataset.preset === preset);
    });

    applySettingMode(settingModeInput.value);

    const settingCustomType = document.getElementById('setting_custom_type');
    const settingTypeOtherWrap = document.getElementById('settingTypeOtherWrap');
    settingCustomType.addEventListener('change', () => {
      settingTypeOtherWrap.classList.toggle('hidden', settingCustomType.value !== 'other');
    });

    const settingRealismChips = document.getElementById('settingRealismChips');
    const settingRealismInput = document.getElementById('setting_custom_realism');
    settingRealismChips.addEventListener('click', (e) => {
      const btn = e.target.closest('.chip');
      if (!btn) return;
      const v = btn.dataset.value;
      settingRealismInput.value = v;
      setActiveChip(settingRealismChips, (chip) => chip.dataset.value === v);
    });

    function updateNote() {
      const t = translations[currentLang];
      const requests = [];

      if (mainHeroModeInput.value === 'photo') {
        requests.push(currentLang === 'ru' ? '—Ñ–æ—Ç–æ –≥–ª–∞–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è' : 'main character photo');
      }

      const hasSecond = secondHeroNameInput.value.trim().length > 0;
      const secondMode = hasSecond ? secondHeroModeInput.value : 'none';
      if (secondMode === 'photo') {
        requests.push(currentLang === 'ru' ? '—Ñ–æ—Ç–æ –≤—Ç–æ—Ä–æ–≥–æ –≥–µ—Ä–æ—è' : 'second character photo');
      }

      if (requests.length === 0) {
        document.getElementById('note').textContent = t.note_base;
        return;
      }

      const orderHintRu = '–ü–æ—Ä—è–¥–æ–∫ –∑–∞–ø—Ä–æ—Å–∞: —Å–Ω–∞—á–∞–ª–∞ –≥–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π, –∑–∞—Ç–µ–º –≤—Ç–æ—Ä–æ–π.';
      const orderHintEn = 'Request order: main character first, then second.';
      const list = requests.join(', ');

      document.getElementById('note').textContent =
        t.note_base + ' ' +
        (currentLang === 'ru'
          ? `–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –±–æ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç: ${list}. ${orderHintRu}`
          : `After submission, the bot will ask for: ${list}. ${orderHintEn}`);
    }

    updateNote();

    function buildPostSubmitPhotoRequests() {
      const arr = [];
      if (mainHeroModeInput.value === 'photo') arr.push('main_hero');

      const hasSecond = secondHeroNameInput.value.trim().length > 0;
      const secondMode = hasSecond ? secondHeroModeInput.value : 'none';
      if (secondMode === 'photo') arr.push('second_hero');

      return arr;
    }

    function validateSecondHeroCustomIfNeeded() {
      const hasSecond = secondHeroNameInput.value.trim().length > 0;
      if (!hasSecond) return true;
      if (secondHeroModeInput.value !== 'custom') return true;

      const trait1 = document.getElementById('second_trait_1').value.trim();
      const trait2 = document.getElementById('second_trait_2').value.trim();
      const trait3 = document.getElementById('second_trait_3').value.trim();

      const m1 = document.getElementById('second_marker_1').value.trim();
      const m2 = document.getElementById('second_marker_2').value.trim();

      return Boolean(trait1 && trait2 && trait3 && m1 && m2);
    }

    function validateSettingCustomIfNeeded() {
      if (settingModeInput.value !== 'custom') return true;
      const d1 = document.getElementById('setting_detail_1').value.trim();
      const d2 = document.getElementById('setting_detail_2').value.trim();
      const d3 = document.getElementById('setting_detail_3').value.trim();
      return Boolean(d1 && d2 && d3);
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      submitBtn.disabled = true;

      if (!isTelegramWebApp) {
        alert(currentLang === 'ru' ? '–û—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤–Ω—É—Ç—Ä–∏ Telegram' : 'Not opened inside Telegram');
        submitBtn.disabled = false;
        return;
      }

      if (!validateSecondHeroCustomIfNeeded()) {
        alert(currentLang === 'ru'
          ? '–î–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≤—Ç–æ—Ä–æ–≥–æ –≥–µ—Ä–æ—è –∑–∞–ø–æ–ª–Ω–∏—Ç–µ 3 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏ –º–∏–Ω–∏–º—É–º 2 –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–∞.'
          : 'For a custom second character, fill 3 traits and at least 2 visual markers.');
        submitBtn.disabled = false;
        return;
      }

      if (!validateSettingCustomIfNeeded()) {
        alert(currentLang === 'ru'
          ? '–î–ª—è –ø–µ—Ä—Å–æ–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ 3 –¥–µ—Ç–∞–ª–∏.'
          : 'For a personalised place, fill 3 details.');
        submitBtn.disabled = false;
        return;
      }

      const mainMode = mainHeroModeInput.value;

      const mainHeroAppearance =
        (mainMode === 'select')
          ? {
              age_years: document.getElementById('main_age_years').value.trim() || null,
              gender: document.getElementById('main_gender').value,
              skin_tone: document.getElementById('main_skin_tone').value,
              face_shape: document.getElementById('main_face_shape').value,
              face_accent: document.getElementById('main_face_accent').value.trim() || null,
              eyes_color: document.getElementById('main_eyes_color').value,
              eyes_shape: document.getElementById('main_eyes_shape').value,
              eyes_size: document.getElementById('main_eyes_size').value,
              hair_color: document.getElementById('main_hair_color').value,
              hair_length: document.getElementById('main_hair_length').value,
              hair_type: document.getElementById('main_hair_type').value,
              hair_density: document.getElementById('main_hair_density').value,
              bangs: document.getElementById('main_bangs').value,
              parting: document.getElementById('main_parting').value,
              nose: document.getElementById('main_nose').value,
              lips: document.getElementById('main_lips').value,
              body_type: document.getElementById('main_body_type').value,
              height_vs_peers: document.getElementById('main_height_vs_peers').value,
              special_features: document.getElementById('main_special_features').value.trim() || null,
              signature_look: document.getElementById('main_signature_look').value.trim() || null
            }
          : null;

      const secondName = secondHeroNameInput.value.trim() || null;
      const hasSecond = Boolean(secondName);
      const secondMode = hasSecond ? (secondHeroModeInput.value || 'preset') : 'none';

      let secondHeroPresetId = null;
      let secondHeroCustom = null;

      if (hasSecond && secondMode === 'preset') {
        secondHeroPresetId = secondHeroPresetIdInput.value;
      }

      if (hasSecond && secondMode === 'custom') {
        const type = document.getElementById('second_custom_type').value;
        secondHeroCustom = {
          type,
          type_other_text: type === 'other'
            ? (document.getElementById('second_custom_type_other_text').value.trim() || null)
            : null,
          role: document.getElementById('second_custom_role').value,
          traits: [
            document.getElementById('second_trait_1').value.trim(),
            document.getElementById('second_trait_2').value.trim(),
            document.getElementById('second_trait_3').value.trim()
          ],
          visual_markers: [
            document.getElementById('second_marker_1').value.trim(),
            document.getElementById('second_marker_2').value.trim(),
            document.getElementById('second_marker_3').value.trim()
          ].filter(Boolean).slice(0, 3),
          unique_prop: document.getElementById('second_unique_prop').value.trim() || null
        };
      }

      const settingMode = settingModeInput.value;
      let settingPresetId = null;
      let settingCustom = null;

      if (settingMode === 'preset') {
        settingPresetId = settingPresetIdInput.value;
      } else {
        const placeType = document.getElementById('setting_custom_type').value;
        settingCustom = {
          type: placeType,
          type_other_text: placeType === 'other'
            ? (document.getElementById('setting_custom_type_other_text').value.trim() || null)
            : null,
          time_of_day: document.getElementById('setting_custom_time').value,
          season: document.getElementById('setting_custom_season').value,
          details: [
            document.getElementById('setting_detail_1').value.trim(),
            document.getElementById('setting_detail_2').value.trim(),
            document.getElementById('setting_detail_3').value.trim()
          ],
          realism: document.getElementById('setting_custom_realism').value
        };
      }

      const payload = {
        type: 'storybook_form',
        session_id: sessionId,
        lang: currentLang,
        form_data: {
          main_hero_name: document.getElementById('main_hero_name').value.trim(),
          main_hero_appearance_mode: mainMode,
          main_hero_appearance: mainHeroAppearance,

          second_hero_name: secondName,
          second_hero_mode: secondMode,
          second_hero_preset_id: secondHeroPresetId,
          second_hero_custom: secondHeroCustom,

          setting_mode: settingMode,
          setting_preset_id: settingPresetId,
          setting_custom: settingCustom,

          age_group: document.getElementById('age_group').value,
          narrative_style: document.getElementById('narrative_style').value,
          moral_theme: document.getElementById('moral_theme').value,
          illustration_style_id: document.getElementById('illustration_style_id').value,
          language: document.getElementById('language').value,

          ui_language: currentLang,
          post_submit_photo_requests: buildPostSubmitPhotoRequests()
        },
        telegram: {
          initData: tg.initData,
          user: tg.initDataUnsafe?.user || null
        }
      };

      try {
        await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        tg.close();
      } catch (err) {
        console.error(err);
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
